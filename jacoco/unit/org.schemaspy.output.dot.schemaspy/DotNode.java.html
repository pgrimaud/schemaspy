<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DotNode.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SchemaSpy</a> &gt; <a href="index.source.html" class="el_package">org.schemaspy.output.dot.schemaspy</a> &gt; <span class="el_source">DotNode.java</span></div><h1>DotNode.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2004 - 2011 John Currier
 * Copyright (C) 2016 Rafal Kasa
 * Copyright (C) 2017 Wojciech Kasa
 * Copyright (C) 2017 Daniel Watt
 * Copyright (C) 2018 Nils Petzaell
 * Copyright (C) 2019 Kamyab Nazari
 *
 * This file is a part of the SchemaSpy project (http://schemaspy.org).
 *
 * SchemaSpy is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * SchemaSpy is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 */
package org.schemaspy.output.dot.schemaspy;

import org.schemaspy.model.Table;
import org.schemaspy.model.TableColumn;
import org.schemaspy.model.TableIndex;
import org.schemaspy.output.dot.DotConfig;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.awt.*;
import java.awt.font.FontRenderContext;
import java.awt.geom.AffineTransform;
import java.io.UnsupportedEncodingException;
import java.lang.invoke.MethodHandles;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.text.NumberFormat;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.Objects;
import java.util.Set;

/**
 * @author John Currier
 * @author Rafal Kasa
 * @author Wojciech Kasa
 * @author Thomas Traude
 * @author Daniel Watt
 * @author Nils Petzaell
 */
public class DotNode {

<span class="fc" id="L57">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
<span class="fc" id="L58">    private static final Html html = new Html();</span>
<span class="fc" id="L59">    private static final StyleSheet CSS = StyleSheet.getInstance();</span>

    private static final String INDENT_6 = &quot;      &quot;;

    private final Table table;
    private final String path;
    private final DotNodeConfig config;
    private final DotConfig dotConfig;
<span class="fc" id="L67">    private final Set&lt;TableColumn&gt; excludedColumns = new HashSet&lt;&gt;();</span>
<span class="fc" id="L68">    private final String lineSeparator = System.getProperty(&quot;line.separator&quot;);</span>
    private final String columnSpan;

    private boolean showImpliedRelationships;

<span class="fc" id="L73">    public DotNode(Table table, boolean fromRoot, DotNodeConfig config, DotConfig dotConfig) {</span>
<span class="fc" id="L74">        this.table = table;</span>
<span class="fc" id="L75">        this.config = config;</span>
<span class="fc" id="L76">        this.dotConfig = dotConfig;</span>
<span class="fc" id="L77">        this.path = createPath(fromRoot);</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        this.columnSpan = config.showColumnDetails ? &quot;COLSPAN=\&quot;2\&quot; &quot; : &quot;COLSPAN=\&quot;3\&quot; &quot;;</span>
<span class="fc" id="L79">    }</span>

    private String createPath(boolean fromRoot) {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (dotConfig.useRelativeLinks()) {</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            return (table.isRemote() ? &quot;../../../&quot; + table.getContainer() : &quot;../..&quot;) + &quot;/tables/&quot;;</span>
        }
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (fromRoot) {</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">            return (table.isRemote() ? (&quot;../&quot; + table.getContainer() + &quot;/tables/&quot;) : &quot;tables/&quot;);</span>
        }
<span class="fc bfc" id="L88" title="All 2 branches covered.">        return (table.isRemote() ? (&quot;../../&quot; + table.getContainer() + &quot;/tables/&quot;) : &quot;&quot;);</span>

    }

    public void setShowImplied(boolean showImplied) {
<span class="nc" id="L93">        showImpliedRelationships = showImplied;</span>
<span class="nc" id="L94">    }</span>

    public Table getTable() {
<span class="nc" id="L97">        return table;</span>
    }

    public void excludeColumn(TableColumn column) {
<span class="nc" id="L101">        excludedColumns.add(column);</span>
<span class="nc" id="L102">    }</span>

    @Override
    public String toString() {
<span class="fc" id="L106">        StringBuilder buf = new StringBuilder();</span>
<span class="fc" id="L107">        String tableName = table.getName();</span>
        // fully qualified table name (optionally prefixed with schema)
<span class="fc bfc" id="L109" title="All 2 branches covered.">        String fqTableName = (table.isRemote() ? table.getContainer() + &quot;.&quot; : &quot;&quot;) + tableName;</span>
<span class="fc" id="L110">        int maxTitleWidth = getTitleMaxWidth(fqTableName);</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        String colspanHeader = config.showColumnDetails ? &quot;COLSPAN=\&quot;4\&quot; &quot; : &quot;COLSPAN=\&quot;3\&quot; &quot;;</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        String tableOrView = table.isView() ? &quot;view&quot; : &quot;table&quot;;</span>

<span class="fc" id="L114">        buf.append(&quot;  \&quot;&quot; + fqTableName + &quot;\&quot; [&quot; + lineSeparator);</span>
<span class="fc" id="L115">        buf.append(&quot;   label=&lt;&quot; + lineSeparator);</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        buf.append(&quot;    &lt;TABLE BORDER=\&quot;&quot; + (config.showColumnDetails ? &quot;2&quot; : &quot;0&quot;) + &quot;\&quot; CELLBORDER=\&quot;1\&quot; CELLSPACING=\&quot;0\&quot; BGCOLOR=\&quot;&quot; + CSS.getTableBackground() + &quot;\&quot;&gt;&quot; + lineSeparator);</span>
<span class="fc" id="L117">        buf.append(INDENT_6 + Html.TR_START);</span>
<span class="fc" id="L118">        buf.append(&quot;&lt;TD &quot; + colspanHeader + &quot; BGCOLOR=\&quot;&quot; + CSS.getTableHeadBackground() + &quot;\&quot;&gt;&quot;);</span>
<span class="fc" id="L119">        buf.append(&quot;&lt;TABLE BORDER=\&quot;0\&quot; CELLSPACING=\&quot;0\&quot;&gt;&quot;);</span>
<span class="fc" id="L120">        buf.append(Html.TR_START);</span>
<span class="fc" id="L121">        buf.append(&quot;&lt;TD ALIGN=\&quot;LEFT\&quot; FIXEDSIZE=\&quot;TRUE\&quot; WIDTH=\&quot;&quot; + maxTitleWidth + &quot;\&quot; HEIGHT=\&quot;16\&quot;&gt;&lt;B&gt;&quot; + escapeHtml(fqTableName) +&quot;&lt;/B&gt;&quot; + Html.TD_END);</span>
<span class="fc" id="L122">        buf.append(&quot;&lt;TD ALIGN=\&quot;RIGHT\&quot;&gt;[&quot; + tableOrView + &quot;]&quot; + Html.TD_END);</span>
<span class="fc" id="L123">        buf.append(Html.TR_END);</span>
<span class="fc" id="L124">        buf.append(&quot;&lt;/TABLE&gt;&quot;);</span>
<span class="fc" id="L125">        buf.append(Html.TD_END);</span>
<span class="fc" id="L126">        buf.append(Html.TR_END + lineSeparator);</span>

<span class="fc" id="L128">        buf.append(columnsToString());</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        if (!table.isView()) {</span>
<span class="fc" id="L130">            buf.append(tableToString());</span>
        }

<span class="fc" id="L133">        buf.append(&quot;    &lt;/TABLE&gt;&gt;&quot; + lineSeparator);</span>
<span class="pc bpc" id="L134" title="1 of 4 branches missed.">        if (!table.isRemote() || dotConfig.isOneOfMultipleSchemas()) {</span>
<span class="fc" id="L135">            buf.append(&quot;    URL=\&quot;&quot; + path + urlEncodeLink(tableName) + &quot;.html\&quot;&quot; + lineSeparator);</span>
<span class="fc" id="L136">            buf.append(&quot;    target=\&quot;_top\&quot;&quot; + lineSeparator);</span>
        }
<span class="fc" id="L138">        buf.append(&quot;    tooltip=\&quot;&quot; + escapeHtml(fqTableName) + &quot;\&quot;&quot; + lineSeparator);</span>
<span class="fc" id="L139">        buf.append(&quot;  ];&quot;);</span>

<span class="fc" id="L141">        return buf.toString();</span>
    }

    private String columnsToString() {
<span class="fc" id="L145">        StringBuilder buf = new StringBuilder();</span>
<span class="fc" id="L146">        boolean skippedTrivial = false;</span>

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (config.showColumns) {</span>
<span class="fc" id="L149">            Set&lt;TableColumn&gt; indexColumns = getIndexColumns();</span>
<span class="fc" id="L150">            int maxWidth = getColumnMaxWidth();</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            for (TableColumn column : table.getColumns()) {</span>
<span class="pc bpc" id="L152" title="9 of 10 branches missed.">                if (config.showTrivialColumns || config.showColumnDetails || column.isPrimary() || column.isForeignKey() || indexColumns.contains(column)) {</span>
<span class="fc" id="L153">                    buf.append(columnToString(column, indexColumns, maxWidth));</span>
                } else {
<span class="nc" id="L155">                    skippedTrivial = true;</span>
                }
<span class="fc" id="L157">            }</span>
        }

<span class="pc bpc" id="L160" title="2 of 4 branches missed.">        if (skippedTrivial || !config.showColumns) {</span>
<span class="nc" id="L161">            buf.append(INDENT_6 + Html.TR_START + &quot;&lt;TD PORT=\&quot;elipses\&quot; COLSPAN=\&quot;3\&quot; ALIGN=\&quot;LEFT\&quot;&gt;...&quot; + Html.TD_END + Html.TR_END + lineSeparator);</span>
        }
<span class="fc" id="L163">        return buf.toString();</span>
    }

    private Set&lt;TableColumn&gt; getIndexColumns() {
<span class="fc" id="L167">        Set&lt;TableColumn&gt; indexColumns = new LinkedHashSet&lt;&gt;();</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        for (TableIndex index : table.getIndexes()) {</span>
<span class="nc" id="L169">            indexColumns.addAll(index.getColumns());</span>
<span class="nc" id="L170">        }</span>
<span class="fc" id="L171">        indexColumns.removeAll(table.getPrimaryColumns());</span>
<span class="fc" id="L172">        return indexColumns;</span>
    }

    private int getTitleMaxWidth(String titleTable) {
<span class="fc" id="L176">        int maxTitleWidth = getTextWidth(titleTable);</span>
<span class="fc" id="L177">        return maxTitleWidth;</span>
    }
    
    private int getColumnMaxWidth() {
<span class="fc" id="L181">        int maxWidth = getTextWidth(table.getName());</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">        for (TableColumn column : table.getColumns()) {</span>
<span class="fc" id="L183">            int size = getTextWidth(column.getName());</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">            if (maxWidth &lt; size) {</span>
<span class="nc" id="L185">                maxWidth = size;</span>
            }
<span class="fc" id="L187">        }</span>
<span class="fc" id="L188">        return maxWidth;</span>
    }

    private int getTextWidth(String text) {
<span class="fc" id="L192">        AffineTransform affinetransform = new AffineTransform();</span>
<span class="fc" id="L193">        FontRenderContext frc = new FontRenderContext(affinetransform, true, true);</span>
<span class="fc" id="L194">        int fontSize = dotConfig.getFontSize() + 1;</span>
<span class="fc" id="L195">        Font font = new Font(dotConfig.getFont(), Font.BOLD, fontSize);</span>
<span class="fc" id="L196">        return (int) (font.getStringBounds(text, frc).getWidth());</span>
    }

    private String columnToString(TableColumn column, Set&lt;TableColumn&gt; indexColumns, int maxWidth) {
<span class="fc" id="L200">        StringBuilder buf = new StringBuilder();</span>
<span class="fc" id="L201">        buf.append(INDENT_6 + Html.TR_START);</span>
<span class="fc" id="L202">        buf.append(&quot;&lt;TD PORT=\&quot;&quot; + escapeHtml(column.getName()) + &quot;\&quot; &quot; + columnSpan);</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        if (excludedColumns.contains(column))</span>
<span class="nc" id="L204">            buf.append(&quot;BGCOLOR=\&quot;&quot; + CSS.getExcludedColumnBackgroundColor() + &quot;\&quot; &quot;);</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">        else if (indexColumns.contains(column))</span>
<span class="nc" id="L206">            buf.append(&quot;BGCOLOR=\&quot;&quot; + CSS.getIndexedColumnBackground() + &quot;\&quot; &quot;);</span>
<span class="fc" id="L207">        buf.append(&quot;ALIGN=\&quot;LEFT\&quot;&gt;&quot;);</span>
<span class="fc" id="L208">        buf.append(&quot;&lt;TABLE BORDER=\&quot;0\&quot; CELLSPACING=\&quot;0\&quot; ALIGN=\&quot;LEFT\&quot;&gt;&quot;);</span>
<span class="fc" id="L209">        buf.append(&quot;&lt;TR ALIGN=\&quot;LEFT\&quot;&gt;&quot;);</span>
<span class="fc" id="L210">        buf.append(&quot;&lt;TD ALIGN=\&quot;LEFT\&quot; FIXEDSIZE=\&quot;TRUE\&quot; WIDTH=\&quot;15\&quot; HEIGHT=\&quot;16\&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (column.isPrimary()) {</span>
<span class="nc" id="L212">            buf.append(&quot;&lt;IMG SRC=\&quot;../../images/primaryKeys.png\&quot;/&gt;&quot;);</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        } else if (column.isForeignKey()) {</span>
<span class="nc" id="L214">            buf.append(&quot;&lt;IMG SRC=\&quot;../../images/foreignKeys.png\&quot;/&gt;&quot;);</span>
        }
<span class="fc" id="L216">        buf.append(Html.TD_END);</span>
<span class="fc" id="L217">        buf.append(&quot;&lt;TD ALIGN=\&quot;LEFT\&quot; FIXEDSIZE=\&quot;TRUE\&quot; WIDTH=\&quot;&quot; + maxWidth + &quot;\&quot; HEIGHT=\&quot;16\&quot;&gt;&quot;);</span>
<span class="fc" id="L218">        buf.append(escapeHtml(column.getName()));</span>
<span class="fc" id="L219">        buf.append(Html.TD_END);</span>
<span class="fc" id="L220">        buf.append(Html.TR_END);</span>
<span class="fc" id="L221">        buf.append(&quot;&lt;/TABLE&gt;&quot;);</span>
<span class="fc" id="L222">        buf.append(Html.TD_END);</span>

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (config.showColumnDetails) {</span>
<span class="fc" id="L225">            buf.append(&quot;&lt;TD PORT=\&quot;&quot;);</span>
<span class="fc" id="L226">            buf.append(escapeHtml(column.getName()));</span>
<span class="fc" id="L227">            buf.append(&quot;.type\&quot; ALIGN=\&quot;LEFT\&quot;&gt;&quot;);</span>
<span class="fc" id="L228">            buf.append(escapeHtml(column.getShortTypeName().toLowerCase()));</span>
<span class="pc bpc" id="L229" title="1 of 4 branches missed.">            if (Objects.nonNull(column.getDetailedSize()) &amp;&amp; !column.getDetailedSize().isEmpty()) {</span>
<span class="fc" id="L230">                buf.append(&quot;[&quot;);</span>
<span class="fc" id="L231">                buf.append(escapeHtml(column.getDetailedSize()));</span>
<span class="fc" id="L232">                buf.append(&quot;]&quot;);</span>
            }
<span class="fc" id="L234">            buf.append(Html.TD_END);</span>
        }
<span class="fc" id="L236">        buf.append(Html.TR_END + lineSeparator);</span>
<span class="fc" id="L237">        return buf.toString();</span>
    }

    private String tableToString() {
<span class="fc" id="L241">        StringBuilder buf = new StringBuilder();</span>
<span class="fc" id="L242">        buf.append(INDENT_6 + Html.TR_START);</span>
<span class="fc" id="L243">        buf.append(&quot;&lt;TD ALIGN=\&quot;LEFT\&quot; BGCOLOR=\&quot;&quot; + CSS.getBodyBackground() + &quot;\&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        int numParents = showImpliedRelationships ? table.getNumParents() : table.getNumNonImpliedParents();</span>
<span class="pc bpc" id="L245" title="2 of 4 branches missed.">        if (numParents &gt; 0 || config.showColumnDetails)</span>
<span class="fc" id="L246">            buf.append(&quot;&amp;lt; &quot; + numParents);</span>
        else
<span class="nc" id="L248">            buf.append(&quot;  &quot;);</span>

<span class="fc" id="L250">        buf.append(Html.TD_END);</span>
<span class="fc" id="L251">        buf.append(&quot;&lt;TD ALIGN=\&quot;RIGHT\&quot; BGCOLOR=\&quot;&quot; + CSS.getBodyBackground() + &quot;\&quot;&gt;&quot;);</span>
<span class="fc" id="L252">        final long numRows = table.getNumRows();</span>
<span class="pc bpc" id="L253" title="2 of 4 branches missed.">        if (dotConfig.isNumRowsEnabled() &amp;&amp; numRows &gt;= 0) {</span>
<span class="fc" id="L254">            buf.append(NumberFormat.getInstance().format(numRows));</span>
<span class="fc" id="L255">            buf.append(&quot; row&quot;);</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">            if (numRows != 1)</span>
<span class="fc" id="L257">                buf.append('s');</span>
        } else {
<span class="nc" id="L259">            buf.append(&quot;  &quot;);</span>
        }
<span class="fc" id="L261">        buf.append(Html.TD_END);</span>

<span class="fc" id="L263">        buf.append(&quot;&lt;TD ALIGN=\&quot;RIGHT\&quot; BGCOLOR=\&quot;&quot; + CSS.getBodyBackground() + &quot;\&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">        int numChildren = showImpliedRelationships ? table.getNumChildren() : table.getNumNonImpliedChildren();</span>
<span class="pc bpc" id="L265" title="2 of 4 branches missed.">        if (numChildren &gt; 0 || config.showColumnDetails)</span>
<span class="fc" id="L266">            buf.append(numChildren + &quot; &amp;gt;&quot;);</span>
        else
<span class="nc" id="L268">            buf.append(&quot;  &quot;);</span>
<span class="fc" id="L269">        buf.append(Html.TD_END + Html.TR_END + lineSeparator);</span>
<span class="fc" id="L270">        return buf.toString();</span>
    }

    /**
     * HTML escape the specified string
     *
     * @param string
     * @return
     */
    private static String escapeHtml(String string) {
<span class="fc" id="L280">        return html.escape(string);</span>
    }

    private static String urlEncodeLink(String string) {
        try {
<span class="fc" id="L285">            return URLEncoder.encode(string, StandardCharsets.UTF_8.name()).replace(&quot;+&quot;,&quot;%20&quot;);</span>
<span class="nc" id="L286">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L287">            LOGGER.error(&quot;Error trying to urlEncode string [{}] with encoding [{}]&quot;, string, StandardCharsets.UTF_8.name(), e);</span>
<span class="nc" id="L288">            return string;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>